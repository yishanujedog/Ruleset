name: Compile mihomo
on:
  workflow_run:
    workflows: ["Compile sing-box"]
    types: [completed]
    branches: [main]
  workflow_dispatch:
permissions:
  contents: write
env:
  MIHOMO_VERSION: Prerelease-Alpha
jobs:
  compile:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      - uses: actions/setup-python@v6
        with:
          python-version: "3.13"
          cache: "pip"
      - shell: bash
        run: |
          python -Im pip install --upgrade pip
          python -Im pip install --requirement requirements.txt
      - uses: actions/setup-go@v6
        with:
          go-version: ^1.24
      - shell: bash
        run: |
          python main.py
      - id: version
        shell: bash
        run: |
          version=$(curl -sL https://api.github.com/repos/SagerNet/sing-box/releases | jq -r '.[0].tag_name[1:]')
          echo "version=$version" >> $GITHUB_OUTPUT
      - shell: bash
        run: |
          if [ ! -d "srsc" ]; then
            git submodule add https://github.com/yishanujedog/sing-rule.git srsc
          fi
          git submodule update --init --recursive srsc
          cd srsc
          go clean -modcache
          go get github.com/sagernet/sing-box@v${{ steps.version.outputs.version }}
          go mod tidy
          go build -o srsc ./cmd/srsc
          cd ..
      - shell: bash
        run: |
          workdir="$(mktemp -d)"
          trap 'rm -rf "$workdir"' EXIT

          MIHOMO_VERSION="Prerelease-Alpha"
          PACKAGE_NAME=$(curl -s \
            -H "Authorization: Bearer ${{ github.token }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/MetaCubeX/mihomo/releases/tags/$MIHOMO_VERSION" | \
            jq -r '.assets[] | select(.name | startswith("mihomo-linux-amd64-alpha-") and endswith(".gz")) | .name')

          uri="https://github.com/MetaCubeX/mihomo/releases/download/$MIHOMO_VERSION/$PACKAGE_NAME"
          curl --fail --location --retry 5 --retry-delay 5 --retry-all-errors -o "$workdir/pkg.gz" "$uri"
          gzip -d "$workdir/pkg.gz"
          chmod +x "$workdir/pkg"
          mv "$workdir/pkg" "$workdir/mihomo"
      - shell: bash
        run: |
          ./srsc/srsc run -c srsc.json &
          sleep 5
          curl -s http://127.0.0.1:8080/sing-box/domainset/reject/source || (exit 1)
          curl -s http://127.0.0.1:8080/mihomo/domainset/reject/text || (exit 1)
      - shell: bash
        run: |
          mkdir -p mihomo/srsc/{text,yaml}/{domainset,ip,non_ip,dns}
          mkdir -p mihomo/srsc/mrs/{domain,ipcidr}

          for category in domainset; do
            for file in dist/List/$category/*.conf; do
              [ -f "$file" ] || continue
              name="$(basename "$file" .conf | sed 's/_/-/g')"
              api_name="$(echo "$name" | sed 's/-/_/g')"
              curl -s "http://127.0.0.1:8080/mihomo/$category/$api_name/text" > "mihomo/srsc/text/$category/$name.$category.txt"
              curl -s "http://127.0.0.1:8080/mihomo/$category/$api_name/yaml" > "mihomo/srsc/yaml/$category/$name.$category.yaml"
              curl -s "http://127.0.0.1:8080/mihomo/$category/$api_name/mrs" > "mihomo/srsc/mrs/domain/$name.$category.mrs"
            done
          done

          for file in dist/List/ip/*.conf; do
            [ -f "$file" ] || continue
            name="$(basename "$file" .conf | sed 's/_/-/g')"
            api_name="$(echo "$name" | sed 's/-/_/g')"
            curl -s "http://127.0.0.1:8080/mihomo/ip/$api_name/text" > "mihomo/srsc/text/ip/$name.ip.txt"
            curl -s "http://127.0.0.1:8080/mihomo/ip/$api_name/yaml" > "mihomo/srsc/yaml/ip/$name.ip.yaml"
          done

          for file in dist/List/ip/china_ip.conf dist/List/ip/china_ip_ipv6.conf; do
            [ -f "$file" ] || continue
            name="$(basename "$file" .conf | sed 's/_/-/g')"
            api_name="$(echo "$name" | sed 's/-/_/g')"
            curl -s "http://127.0.0.1:8080/mihomo/ip/$api_name/mrs" > "mihomo/srsc/mrs/ipcidr/$name.ipcidr.mrs"
          done

          for category in non_ip; do
            for file in dist/List/$category/*.conf; do
              [ -f "$file" ] || continue
              name="$(basename "$file" .conf | sed 's/_/-/g')"
              api_name="$(echo "$name" | sed 's/-/_/g')"
              curl -s "http://127.0.0.1:8080/mihomo/$category/$api_name/text" > "mihomo/srsc/text/$category/$name.$category.txt"
              curl -s "http://127.0.0.1:8080/mihomo/$category/$api_name/yaml" > "mihomo/srsc/yaml/$category/$name.$category.yaml"
            done
          done

          for file in dist/Modules/Rules/sukka_local_dns_mapping/*.conf; do
            [ -f "$file" ] || continue
            name="$(basename "$file" .conf | sed 's/_/-/g')"
            api_name="$(echo "$name" | sed 's/-/_/g')"
            curl -s "http://127.0.0.1:8080/mihomo/dns/$api_name/text" > "mihomo/srsc/text/dns/$name.dns.txt"
            curl -s "http://127.0.0.1:8080/mihomo/dns/$api_name/yaml" > "mihomo/srsc/yaml/dns/$name.dns.yaml"
          done
      - shell: bash
        run: |
          pkill -f "srsc run" || true
      - shell: bash
        run: |
          cd mihomo
          shopt -s nullglob

          text_ip_path="text/ip"
          mrs_ip_path="mrs/ipcidr"
          if [ -d "$text_ip_path" ]; then
            mkdir -p "$mrs_ip_path"
            while IFS= read -r -d '' src; do
              base="$(basename "${src%.ip.txt}")"
              "$workdir/mihomo" convert-ruleset ipcidr text "$src" "$mrs_ip_path/${base}.ipcidr.mrs" || continue
            done < <(find "$text_ip_path" -name 'china-ip*.ip.txt' -type f -print0)
          fi

          text_domainset_path="text/domainset"
          mrs_domain_path="mrs/domain"
          if [ -d "$text_domainset_path" ]; then
            mkdir -p "$mrs_domain_path"
            while IFS= read -r -d '' src; do
              base="$(basename "${src%.txt}")"
              "$workdir/mihomo" convert-ruleset domain text "$src" "$mrs_domain_path/${base}.domain.mrs" || continue
            done < <(find "$text_domainset_path" -name '*.txt' -type f -print0)
          fi

          yaml_ip_path="yaml/ip"
          if [ -d "$yaml_ip_path" ]; then
            while IFS= read -r -d '' src; do
              base="$(basename "${src%.ip.yaml}")"
              [ -f "$mrs_ip_path/${base}.ipcidr.mrs" ] || {
                "$workdir/mihomo" convert-ruleset ipcidr yaml "$src" "$mrs_ip_path/${base}.ipcidr.mrs" || continue
              }
            done < <(find "$yaml_ip_path" -name 'china-ip*.ip.yaml' -type f -print0)
          fi

          yaml_domainset_path="yaml/domainset"
          if [ -d "$yaml_domainset_path" ]; then
            while IFS= read -r -d '' src; do
              base="$(basename "${src%.yaml}")"
              [ -f "$mrs_domain_path/${base}.domain.mrs" ] || {
                "$workdir/mihomo" convert-ruleset domain yaml "$src" "$mrs_domain_path/${base}.domain.mrs" || continue
              }
            done < <(find "$yaml_domainset_path" -name '*.yaml' -type f -print0)
          fi
      - shell: bash
        run: |
          if [[ -n "$(git status --porcelain mihomo/mrs)" ]] || [[ -n "$(git status --porcelain mihomo/srsc)" ]]; then
            git add mihomo/mrs mihomo/text mihomo/yaml mihomo/srsc
            git stash push --keep-index
            git commit -m "feat(mihomo): bump [$(date -u +%FT%TZ)]"
            git pull --rebase origin main
            git stash pop || true
            git push
          fi
